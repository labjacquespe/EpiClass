# Justfile for managing test suite with multiple Python versions.
# Uses `uv` (https://pypi.org/project/uv/) for environment and dependency management.
# Uses `pytest` for running tests.

# List all available recipes
list:
    @just --list
    @echo "Use 'just <recipe>' to run a specific recipe."

# Generate timestamp for log files
_timestamp := `date +"%Y%m%d_%H%M%S"`

# Environment check - only runs when explicitly called
check-env:
    @echo "üîç Checking environment..."
    @which uv > /dev/null || (echo "‚ùå uv not found" && exit 1)
    @echo "‚úÖ Environment OK"

# Compile requirements for a specific Python version (separate step for reproducibility)
compile python_version:
    #!/usr/bin/env bash
    set -euo pipefail
    v="{{python_version}}"
    echo "üìã Compiling requirements for Python ${v}..."

    # Ensure we generate exact, reproducible requirements
    uv pip compile -p=${v} ../requirements/req_core.in > ../requirements/req_core_${v}.txt

    echo "‚úÖ Requirements compiled for Python ${v}"
    echo "üìÑ Generated: ../requirements/req_core_${v}.txt"

# Run tests for a specific Python version using pre-compiled requirements
# Optional: pass test_filter to select specific tests (e.g., just test 3.11 "test_foo")
test python_version test_filter="":
    #!/usr/bin/env bash
    set -euo pipefail

    mkdir -p logs
    mkdir -p envs

    v="{{python_version}}"
    timestamp="{{_timestamp}}"
    venv_path="./envs/venv_test_${v}"
    req_file="../requirements/req_core_${v}.txt"
    test_filter="{{test_filter}}"

    log_install="logs/${timestamp}_install_${v}.log"
    log_pytest="logs/${timestamp}_pytest_${v}.log"

    echo "üöÄ Running tests for Python ${v}..."
    echo "üìù Logs will be saved with timestamp: ${timestamp}"

    # Ensure requirements are compatible with the specified Python version
    just compile ${v}

    # Create fresh virtual environment (--clear removes existing one)
    echo "üîÑ Creating fresh virtual environment for Python ${v}..."
    uv venv --seed --clear -p=${v} "$venv_path"
    . "$venv_path/bin/activate"

    echo "üì¶ Installing exact pinned dependencies from ${req_file}..."
    # Install exact requirements first (what users will get)
    uv pip install -r "$req_file" >> logs/pytest-${v}_${timestamp}.log 2>&1

    echo "üì¶ Installing package with test dependencies..."
    uv pip install ../.[test] >> logs/pytest-${v}_${timestamp}.log 2>&1

    echo "üß™ Running pytest for Python ${v}..."
    if [ -n "$test_filter" ]; then
        echo "üîç Filtering tests with: -k '$test_filter'"
        pytest --tb=short -k "$test_filter" ../tests/ &>> $log_pytest || true
    else
        pytest --tb=short ../tests/ &>> $log_pytest || true
    fi

    # Optionally filter out known benign warnings "i" for in-place edit
    del_str="[LightGBM] [Warning] No further splits with positive gain, best gain: -inf"
    sed -i "/$del_str/d" "$log_pytest" || true

    echo "‚úÖ Tests for Python ${v} completed"
    grep -E '[0-9]+ (passed|failed|skipped)' $log_pytest || true
    echo "check logs/ directory for detailled results."

# Compile requirements for all Python versions
compile-all: check-env
    just compile 3.10
    just compile 3.11
    just compile 3.12
    just compile 3.13
    @echo "‚úÖ All requirements compiled"

# Run all tests
test-all test_filter="": check-env
    just test 3.10 "{{test_filter}}"
    just test 3.11 "{{test_filter}}"
    just test 3.12 "{{test_filter}}"
    just test 3.13 "{{test_filter}}"
    @echo "‚úÖ All tests completed"

# Clean up generated files (WARNING: deletes all logs!)
clean:
    #!/usr/bin/env bash
    echo "‚ö†Ô∏è  This will delete ALL log files and cache directories!"
    echo "Press Ctrl+C to cancel, or Enter to continue..."
    read -r
    echo "üßπ Cleaning up..."
    for dir in logs envs ./venv __pycache__ .pytest_cache; do
        if [ -d "$dir" ]; then
            echo "Removing $dir..."
            rm -rf "$dir"
        fi
    done
    echo "‚úÖ Cleanup complete"
